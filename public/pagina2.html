<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selecionar Empregado</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1 id="titulo-pagina"></h1>
        
        <div class="ferramentas-func">
            <div class="form-adicionar">
                <input type="text" id="input-funcionario" placeholder="Nome do novo funcionário">
                <button id="btn-adicionar" class="botao-adicionar">Adicionar</button>
            </div>
        </div>

        <div id="loading" class="mensagem">Carregando empregados...</div>
        <div id="feedback" class="mensagem"></div>

        <div id="empregados-lista" class="lista">
        </div>

        <a href="index.html" class="botao-voltar">Voltar para Empresas</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const empresaId = params.get('empresaId');
            
            const tituloPagina = document.getElementById('titulo-pagina');
            const listaDiv = document.getElementById('empregados-lista');
            const inputFuncionario = document.getElementById('input-funcionario');
            const btnAdicionar = document.getElementById('btn-adicionar');
            const loadingDiv = document.getElementById('loading');
            const feedbackDiv = document.getElementById('feedback');

            let dataJson = null;
            let empresaSelecionada = null;

            // Função para renderizar a lista de funcionários
            const renderizarFuncionarios = (funcionarios) => {
                listaDiv.innerHTML = ''; // Limpa a lista
                if (funcionarios && funcionarios.length > 0) {
                    funcionarios.forEach(funcionario => {
                        const link = document.createElement('a');
                        link.href = `pagina3.html?empresaId=${encodeURIComponent(empresaId)}&funcionarioId=${encodeURIComponent(funcionario.id)}`;
                        link.classList.add('item');
                        link.textContent = funcionario.nome;
                        listaDiv.appendChild(link);
                    });
                } else {
                    feedbackDiv.textContent = 'Nenhum funcionário encontrado.';
                }
            };

            // Função para adicionar um novo funcionário
            const adicionarFuncionario = async () => {
                const novoFuncionarioNome = inputFuncionario.value.trim();
                if (!novoFuncionarioNome) {
                    feedbackDiv.textContent = 'O nome do funcionário não pode estar vazio.';
                    feedbackDiv.style.color = 'red';
                    return;
                }

                if (!empresaSelecionada) {
                    feedbackDiv.textContent = 'Erro: Empresa não carregada.';
                    feedbackDiv.style.color = 'red';
                    return;
                }
                
                // Verifica se o funcionário já existe
                if (empresaSelecionada.funcionarios.some(f => f.nome.toLowerCase() === novoFuncionarioNome.toLowerCase())) {
                    feedbackDiv.textContent = 'Funcionário com este nome já existe.';
                    feedbackDiv.style.color = 'red';
                    return;
                }

                // Cria o novo objeto funcionário
                const novoFuncionario = {
                    id: `func_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    nome: novoFuncionarioNome,
                    grupo_valor_r$: [],
                    grupo_hora: [],
                    grupo_dia: []
                };
                
                empresaSelecionada.funcionarios.push(novoFuncionario);
                
                feedbackDiv.textContent = 'Adicionando funcionário...';
                feedbackDiv.style.color = '#ff8c00';

                try {
                    const response = await fetch('/api/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dataJson)
                    });

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message || 'Erro ao adicionar funcionário.');

                    feedbackDiv.textContent = 'Funcionário adicionado com sucesso!';
                    feedbackDiv.style.color = 'green';
                    inputFuncionario.value = ''; // Limpa o input
                    renderizarFuncionarios(empresaSelecionada.funcionarios); // Atualiza a lista
                    
                } catch (error) {
                    feedbackDiv.textContent = 'Erro: ' + error.message;
                    feedbackDiv.style.color = 'red';
                    // Reverte a adição em caso de erro
                    empresaSelecionada.funcionarios.pop();
                }
            };
            
            btnAdicionar.addEventListener('click', adicionarFuncionario);
            inputFuncionario.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    adicionarFuncionario();
                }
            });

            // Função para buscar e carregar os dados da empresa
            const carregarDados = async () => {
                if (!empresaId) {
                    feedbackDiv.textContent = 'ID da empresa não selecionado.';
                    feedbackDiv.style.color = 'red';
                    window.location.href = 'index.html';
                    return;
                }
                
                loadingDiv.style.display = 'block';
                feedbackDiv.textContent = '';
                
                try {
                    const response = await fetch('/api/data');
                    if (!response.ok) throw new Error('Erro ao carregar dados.');
                    
                    dataJson = await response.json();
                    empresaSelecionada = dataJson.empresas.find(emp => emp.id === empresaId);
                    
                    if (empresaSelecionada) {
                        tituloPagina.textContent = `Empregados da ${empresaSelecionada.nome}`;
                        renderizarFuncionarios(empresaSelecionada.funcionarios);
                    } else {
                        feedbackDiv.textContent = 'Empresa não encontrada.';
                        feedbackDiv.style.color = 'red';
                    }
                } catch (error) {
                    feedbackDiv.textContent = 'Erro: ' + error.message;
                    feedbackDiv.style.color = 'red';
                } finally {
                    loadingDiv.style.display = 'none';
                }
            };

            carregarDados();
        });
    </script>
</body>
</html>