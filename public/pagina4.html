<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Evento</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1 id="titulo-pagina"></h1>
        
        <div id="loading" class="mensagem">Carregando detalhes...</div>
        <div id="feedback" class="mensagem"></div>

        <div id="evento-detalhes" class="item">
            </div>

        <div class="form-adicionar-atividade">
            <input type="text" id="input-atividade" placeholder="Nova atividade">
            <button id="btn-adicionar-atividade" class="botao-adicionar">Adicionar Atividade</button>
        </div>

        <a href="#" onclick="history.back();" class="botao-voltar">Voltar para Grupos</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const funcionarioNome = params.get('funcionario');
            const grupoNome = params.get('grupo');
            const eventosStr = params.get('eventos');

            const tituloPagina = document.getElementById('titulo-pagina');
            const eventoDetalhesDiv = document.getElementById('evento-detalhes');
            const loadingDiv = document.getElementById('loading');
            const feedbackDiv = document.getElementById('feedback');
            const inputAtividade = document.getElementById('input-atividade');
            const btnAdicionarAtividade = document.getElementById('btn-adicionar-atividade');
            
            tituloPagina.textContent = `Atividades de ${funcionarioNome}`;

            const renderizarAtividades = (eventos) => {
                eventoDetalhesDiv.innerHTML = '';
                if (eventos && eventos.length > 0) {
                    eventos.forEach(evento => {
                        const p = document.createElement('p');
                        p.textContent = evento;
                        eventoDetalhesDiv.appendChild(p);
                    });
                } else {
                    eventoDetalhesDiv.innerHTML = '<p>Nenhuma atividade encontrada neste grupo.</p>';
                }
            };
            
            if (funcionarioNome && grupoNome && eventosStr) {
                const eventos = eventosStr.split(',');
                renderizarAtividades(eventos);
                loadingDiv.style.display = 'none';
            } else {
                feedbackDiv.textContent = 'Dados insuficientes para exibir a página.';
                feedbackDiv.style.color = 'red';
                loadingDiv.style.display = 'none';
            }

            // Função para adicionar uma nova atividade
            const adicionarAtividade = async () => {
                const novaAtividade = inputAtividade.value.trim();
                if (!novaAtividade) {
                    feedbackDiv.textContent = 'Por favor, insira o nome da atividade.';
                    feedbackDiv.style.color = 'red';
                    return;
                }

                feedbackDiv.textContent = 'Adicionando atividade...';
                feedbackDiv.style.color = '#ff8c00';

                try {
                    // Fetch para a API que salva a nova atividade no servidor
                    const response = await fetch('/api/add-atividade', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            funcionario: funcionarioNome,
                            grupo: grupoNome,
                            novaAtividade: novaAtividade
                        })
                    });

                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message || 'Erro ao adicionar a atividade.');

                    feedbackDiv.textContent = 'Atividade adicionada com sucesso!';
                    feedbackDiv.style.color = 'green';
                    inputAtividade.value = '';
                    setTimeout(() => {
                        window.location.reload(); // Recarrega a página para mostrar a nova atividade
                    }, 1000);

                } catch (error) {
                    feedbackDiv.textContent = 'Erro: ' + error.message;
                    feedbackDiv.style.color = 'red';
                }
            };
            
            btnAdicionarAtividade.addEventListener('click', adicionarAtividade);
            inputAtividade.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    adicionarAtividade();
                }
            });
        });
    </script>
</body>
</html>